=============================================================================
  FOLIATE EVENT BRIDGE ARCHITECTURE - COMPLETE FLOW DIAGRAM
=============================================================================

SCENARIO: User clicks on an annotation in the ebook


â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  LAYER 1: FOLIATE-JS SOURCE LAYER                                       â”‚
â”‚  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•  â”‚
â”‚                                                                         â”‚
â”‚  ğŸ“„ File: reader.js (or overlayer.js)                                   â”‚
â”‚                                                                         â”‚
â”‚  Event Source Code:                                                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ this.view.addEventListener('show-annotation', e => {            â”‚ â”‚
â”‚  â”‚     const annotation = this.annotationsByValue.get(e.detail.value)â”‚ â”‚
â”‚  â”‚     if (annotation.note) alert(annotation.note)                  â”‚ â”‚
â”‚  â”‚ })                                                                â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                         â”‚
â”‚  When triggered:                                                       â”‚
â”‚  â€¢ Event name: 'show-annotation' (kebab-case)                         â”‚
â”‚  â€¢ Event.detail: { value: 'epubcfi(...)' }                            â”‚
â”‚  â€¢ Fires on: foliate-view element                                     â”‚
â”‚                                                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
                         â”‚ Event bubbles up through DOM
                         â”‚
                         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  LAYER 2: FLUTTER-BRIDGE RELAY LAYER (JavaScript/Bridge)               â”‚
â”‚  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•  â”‚
â”‚                                                                         â”‚
â”‚  ğŸ“„ File: assets/foliate/flutter-bridge.js                             â”‚
â”‚                                                                         â”‚
â”‚  Bridge Code:                                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ view.addEventListener('show-annotation', (event) => {            â”‚ â”‚
â”‚  â”‚     const { value } = event.detail || {};                        â”‚ â”‚
â”‚  â”‚                                                                   â”‚ â”‚
â”‚  â”‚     // Log for debugging                                         â”‚ â”‚
â”‚  â”‚     logToFlutter(`ğŸ“Œ show-annotation fired...`);                 â”‚ â”‚
â”‚  â”‚                                                                   â”‚ â”‚
â”‚  â”‚     // Relay to Flutter via InAppWebView bridge                  â”‚ â”‚
â”‚  â”‚     window.flutter_inappwebview?.callHandler(                    â”‚ â”‚
â”‚  â”‚         'showAnnotation',    // â† camelCase                      â”‚ â”‚
â”‚  â”‚         { value, detail: event.detail }                          â”‚ â”‚
â”‚  â”‚     );                                                            â”‚ â”‚
â”‚  â”‚ });                                                               â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                         â”‚
â”‚  Responsibilities:                                                     â”‚
â”‚  âœ“ Listen to foliate-js event                                         â”‚
â”‚  âœ“ Extract and serialize event data                                   â”‚
â”‚  âœ“ Log for debugging                                                  â”‚
â”‚  âœ“ Call flutter_inappwebview handler                                  â”‚
â”‚  âœ“ Handle errors gracefully                                           â”‚
â”‚                                                                         â”‚
â”‚  Key Notes:                                                            â”‚
â”‚  â€¢ This is where foliate-js events enter the bridge                   â”‚
â”‚  â€¢ Convert kebab-case â†’ camelCase                                     â”‚
â”‚  â€¢ Serialize data for JSON transmission                               â”‚
â”‚  â€¢ Always include logging                                             â”‚
â”‚                                                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
                         â”‚ JavaScript calls native bridge
                         â”‚ (InAppWebView plugin handles this)
                         â”‚
                         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  LAYER 3: FOLIATE-WEBVIEW HANDLER LAYER (Dart/Flutter)                 â”‚
â”‚  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•  â”‚
â”‚                                                                         â”‚
â”‚  ğŸ“„ File: lib/widgets/foliate_webview.dart                             â”‚
â”‚  Class: _FoliateWebViewState                                           â”‚
â”‚                                                                         â”‚
â”‚  Handler Registration Code:                                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ controller.addJavaScriptHandler(                                  â”‚ â”‚
â”‚  â”‚     handlerName: 'showAnnotation',  // â† MUST match JS           â”‚ â”‚
â”‚  â”‚     callback: (data) {                                            â”‚ â”‚
â”‚  â”‚         try {                                                     â”‚ â”‚
â”‚  â”‚             if (data is Map) {                                    â”‚ â”‚
â”‚  â”‚                 final detail = Map<String, dynamic>.from(        â”‚ â”‚
â”‚  â”‚                     data as Map<dynamic, dynamic>                 â”‚ â”‚
â”‚  â”‚                 );                                                â”‚ â”‚
â”‚  â”‚                 // Call the widget callback                       â”‚ â”‚
â”‚  â”‚                 widget.onAnnotationEvent?.call(detail);           â”‚ â”‚
â”‚  â”‚             } else if (data is List && data.isNotEmpty) {        â”‚ â”‚
â”‚  â”‚                 final detail = Map<String, dynamic>.from(        â”‚ â”‚
â”‚  â”‚                     data.first as Map<dynamic, dynamic>           â”‚ â”‚
â”‚  â”‚                 );                                                â”‚ â”‚
â”‚  â”‚                 widget.onAnnotationEvent?.call(detail);           â”‚ â”‚
â”‚  â”‚             }                                                     â”‚ â”‚
â”‚  â”‚         } catch (_) {}                                            â”‚ â”‚
â”‚  â”‚         return null;                                              â”‚ â”‚
â”‚  â”‚     },                                                            â”‚ â”‚
â”‚  â”‚ );                                                                â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                         â”‚
â”‚  Responsibilities:                                                     â”‚
â”‚  âœ“ Register JavaScript handler with matching name                     â”‚
â”‚  âœ“ Handle data type conversions (dynamic â†’ Map)                       â”‚
â”‚  âœ“ Parse JSON data into Dart structures                               â”‚
â”‚  âœ“ Call widget callback with processed data                           â”‚
â”‚  âœ“ Handle both Map and List data formats                              â”‚
â”‚  âœ“ Error handling with try-catch                                      â”‚
â”‚                                                                         â”‚
â”‚  Widget Properties:                                                    â”‚
â”‚  â€¢ callback: FoliateAnnotationEventCallback? onAnnotationEvent;        â”‚
â”‚    Defined as: typedef FoliateAnnotationEventCallback =                â”‚
â”‚                void Function(Map<String, dynamic>);                    â”‚
â”‚                                                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
                         â”‚ Callback is triggered
                         â”‚
                         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  LAYER 4: CONSUMER CODE LAYER (Your Business Logic)                    â”‚
â”‚  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•  â”‚
â”‚                                                                         â”‚
â”‚  ğŸ“„ File: lib/screens/reader_screen.dart (or any widget using it)      â”‚
â”‚                                                                         â”‚
â”‚  Usage Example:                                                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ FoliateWebView(                                                   â”‚ â”‚
â”‚  â”‚     controller: _foliateController,                              â”‚ â”‚
â”‚  â”‚     epubFilePath: _bookPath,                                     â”‚ â”‚
â”‚  â”‚     onAnnotationEvent: (detail) {  // â† Callback triggered here  â”‚ â”‚
â”‚  â”‚         final value = detail['value'] as String?;                â”‚ â”‚
â”‚  â”‚         final annotationData = detail['detail'] as Map?;         â”‚ â”‚
â”‚  â”‚                                                                   â”‚ â”‚
â”‚  â”‚         // Now you have the annotation data!                     â”‚ â”‚
â”‚  â”‚         // You can:                                              â”‚ â”‚
â”‚  â”‚         // 1. Show an alert/dialog with the note                â”‚ â”‚
â”‚  â”‚         // 2. Save to database                                   â”‚ â”‚
â”‚  â”‚         // 3. Trigger analytics                                  â”‚ â”‚
â”‚  â”‚         // 4. Update UI state                                    â”‚ â”‚
â”‚  â”‚         // 5. Anything else!                                     â”‚ â”‚
â”‚  â”‚                                                                   â”‚ â”‚
â”‚  â”‚         _showAnnotationNote(value);                              â”‚ â”‚
â”‚  â”‚     },                                                           â”‚ â”‚
â”‚  â”‚ )                                                                â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                         â”‚
â”‚  This is where you implement your business logic:                      â”‚
â”‚  â€¢ Handle annotation display                                          â”‚
â”‚  â€¢ Save user interactions                                             â”‚
â”‚  â€¢ Update app state                                                   â”‚
â”‚  â€¢ Trigger other features                                             â”‚
â”‚                                                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜


=============================================================================
  DATA TRANSFORMATION THROUGH LAYERS
=============================================================================

Foliate-JS Event
  â†“
  event: CustomEvent
  event.type: 'show-annotation'
  event.detail: { value: 'epubcfi(...)' }
  
  â†“ (JavaScript Bridge Layer)
  
JavaScript Handler Call
  â†“
  handler: 'showAnnotation'
  data: { value: 'epubcfi(...)', detail: {...} }
  (serialized to JSON)
  
  â†“ (InAppWebView Bridge - automatic)
  
Dart Callback Receives
  â†“
  data: Map<dynamic, dynamic>
  (needs parsing)
  
  â†“ (Handler code processes)
  
Dart Callback Passes
  â†“
  detail: Map<String, dynamic>
  (type-safe Dart structure)
  
  â†“ (Widget callback receives)
  
Your Code Receives
  â†“
  detail: Map<String, dynamic>
  Can access: detail['value'], detail['detail'], etc.


=============================================================================
  KEY NAMING CONVENTIONS
=============================================================================

Event Name Throughout the Bridge:

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Layer                â”‚  Format              â”‚  Example                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Foliate-JS (reader.js)â”‚ kebab-case          â”‚ 'show-annotation'       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Bridge (JS)           â”‚ camelCase            â”‚ 'showAnnotation'        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Flutter Handler       â”‚ camelCase            â”‚ 'showAnnotation'        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Flutter Callback      â”‚ camelCase + on prefixâ”‚ onAnnotationEvent       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜


=============================================================================
  ERROR HANDLING FLOW
=============================================================================

                     â”Œâ”€ Event Fires
                     â”‚
           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
           â”‚ Layer 2: Bridge   â”‚
           â”‚ Catches Error?    â”‚
           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
          â”‚                     â”‚
    â”Œâ”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”        â”Œâ”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”
    â”‚ NO ERROR   â”‚        â”‚ ERROR      â”‚
    â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜        â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
          â”‚                     â”‚
          â”‚              logToFlutter()
          â”‚              catch block
          â”‚
    â”Œâ”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ callHandler()    â”‚
    â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚
    â”Œâ”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ Layer 3: Handler â”‚
    â”‚ try-catch?       â”‚
    â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚
    â”Œâ”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”
    â”‚ Parse data â”‚
    â”‚ Cast types â”‚
    â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
          â”‚
    â”Œâ”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ Call Callback    â”‚
    â”‚ (if provided)    â”‚
    â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚
    â”Œâ”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”
    â”‚ Your Code  â”‚
    â”‚ Runs Logic â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜


=============================================================================
  DEBUGGING CHECKLIST
=============================================================================

â–¡ Check Flutter-Bridge.js
  â–¡ Is event listener registered? (addEventListener call exists?)
  â–¡ Is logToFlutter() printing? (Check console output)
  â–¡ Is callHandler() being called?
  â–¡ Is handler name camelCase?
  â–¡ Is data being serialized correctly?

â–¡ Check foliate_webview.dart
  â–¡ Is handler registered? (addJavaScriptHandler exists?)
  â–¡ Does handler name exactly match callHandler name?
  â–¡ Is the try-catch working?
  â–¡ Is the callback being called? (Add debugPrint)
  â–¡ Is data casting working?

â–¡ Check Your Code
  â–¡ Is callback provided to FoliateWebView?
  â–¡ Is callback null-safe? (onAnnotationEvent?.)
  â–¡ Can you access detail['value'] without errors?
  â–¡ Is business logic executing?

â–¡ Check Network/Bridge
  â–¡ Is InAppWebView plugin properly configured?
  â–¡ Are permissions set correctly?
  â–¡ Is WebView JavaScript enabled?
  â–¡ Are there any console errors in DevTools?


=============================================================================
  SUMMARY
=============================================================================

The event flow is:

  Foliate-JS Event (reader.js)
    â†’ JavaScript Bridge Listener (flutter-bridge.js)
    â†’ JavaScript callHandler() call
    â†’ InAppWebView Bridge (automatic)
    â†’ Flutter Handler (foliate_webview.dart)
    â†’ Widget Callback (onAnnotationEvent)
    â†’ Your Code (reader_screen.dart)

Each layer is responsible for one task. Keep them separate!

Remember: "What fires in foliate-js must be listened in flutter-bridge.js"
          "What's called in flutter-bridge.js must be handled in foliate_webview.dart"
          "What's passed to the callback is what your code receives"




